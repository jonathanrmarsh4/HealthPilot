# Health Insights AI - AI-Powered Health Dashboard

## Overview

Health Insights AI is an AI-powered health insights platform designed to analyze health records, track biomarkers, and deliver personalized health recommendations. It provides AI-generated meal plans, training schedules, and alternative therapy suggestions, empowering users with personalized intelligence and pattern discovery from their health data to optimize well-being. The project aims to optimize user well-being through data-driven insights and actionable recommendations.

## User Preferences

I prefer simple language and clear explanations. I want iterative development where I can provide feedback at each stage. Ask before making major changes to the project structure or core functionalities. Do not make changes to the `replit.nix` file. I primarily use iPad and iPhone for my work. All features must be fully functional and properly responsive on mobile/tablet devices.

## System Architecture

The application is a full-stack project utilizing React, TypeScript, Tailwind CSS, and shadcn/ui for the frontend, and Express.js with TypeScript for the backend. PostgreSQL, accessed via Drizzle ORM, serves as the primary database. AI capabilities are powered by OpenAI GPT-4o.

**UI/UX Decisions:**
- Dark mode support and responsive design, optimized for mobile/tablet.
- Biomarker trend visualization with color-coded badges and compact trend line widgets.
- Purple sparkly AI Chat Widget with a semi-transparent window.
- User-customizable dashboard with persistent widget visibility and order preferences.
- Clear Chat Feature with timestamp-based UI clearing while preserving full conversation history in the database.
- PWA support for iOS home screen installation with custom icon and theme.
- Enhanced Dashboard Widgets: Including a Readiness Score Widget (compact semicircle gauge), Health Score Widget (three-segment donut chart), Biological Age Widget, Goals Summary Widget, and Data Insights Widget.
- Training Page Redesign: Simplified daily-focused UX, removing weekly calendar, renaming sections for clarity, and incorporating collapsible workout history.
- Organized Sidebar Navigation: 5 collapsible sections (About You, Your Plan, Insights, Settings & Data, Admin Panel) with renamed menu items for clarity. Health Coach removed (AI chat accessible via floating widget). Admin Panel visible only to admin users with future features shown as disabled with "Soon" badges.

**Technical Implementations:**
- **AI Intelligence Layer:** Provides daily personalized insights, context-aware chat, multi-metric recommendations, and alternative therapy suggestions with safeguards and goal-driven assistance.
- **AI Expanded Capabilities (Phase 2):** Complete database visibility with controlled write access and comprehensive audit trail. AI can view all user data (biomarkers, sleep, workouts, goals, supplements, meals) without time limitations. Controlled write capabilities include: UPDATE_GOAL (update goal progress/target with metricType resolution), CREATE_GOAL (create new health goals), UPDATE_BIOMARKER (correct biomarker data), and UPDATE_USER_PROFILE (save basic user info during onboarding). All AI-initiated changes are logged to ai_actions audit table with before/after snapshots, reasoning, and success tracking. Dedicated AI Audit Log viewer in admin panel shows full change history with filtering.
- **Meal Feedback System:** Users can provide thumbs up/down feedback on meal suggestions directly in the recipe detail modal. Feedback is saved to the database and used by the AI to learn food preferences and personalize future meal recommendations. AI analyzes feedback patterns to suggest similar meals for liked items and avoid characteristics of disliked meals. Includes proper scrolling fix for mobile recipe viewing.
- **Biomarker Tracking:** Displays data over time, shows reference range status, supports imperial/metric units, includes comprehensive Australian blood work support, HRV tracking from Apple HealthKit, lean body mass tracking, and automatic body fat percentage calculation. Auto-calculates body fat % when both weight and lean body mass are synced using formula: (Weight - Lean Body Mass) / Weight Ã— 100, with smart duplicate prevention.
- **Goal Auto-Update System:** Automatic goal progress updates when new biomarker data syncs from Apple Health webhook. When weight, lean body mass, body fat %, heart rate, or other biomarker data arrives, the system automatically updates any active goals tracking those metrics with the latest values. Ensures goals always reflect current health status without manual updates.
- **Authentication:** Production-ready security using Replit Auth (OpenID Connect) with custom domain support and role-based access control.
- **Security Protections:** Includes IDOR protection, privilege escalation prevention, data isolation, webhook authentication, and Zod schema validation.
- **File Upload Security:** Validation for file size and types (PDF, DOC, DOCX, JPG, PNG, TXT).
- **Sleep Data Implementation:** Uses `inBedStart` and `inBedEnd` for duration, includes awake time, smart deduplication, and custom sleep score calculation.
- **Workout Tracking:** Comprehensive exercise data import from Apple Health via webhook, automatic session creation, and smart matching for training schedules. Supports strength training logs.
- **Recovery Session Integration:** Optional sauna and cold plunge sessions included in AI-generated training plans with smart post-workout scheduling.
- **Training Analytics:** Provides training load calculation, workout statistics, workout-biomarker correlations, and AI-powered recovery insights.
- **Readiness Score System:** Daily readiness calculation using a multi-factor weighted scoring system (Sleep Quality, HRV, Resting Heart Rate, Workout Load Recovery) with safety-first logic for rest recommendations, smart caching, and a dashboard widget visualization. Includes timezone fixes and user-configurable readiness factors with personalized insights, training intensity auto-adjustment, recovery time prediction, and configurable readiness alerts. Advanced recovery protocols are AI-powered, with a library of protocols, smart recommendations, and a user voting system that influences AI suggestions. Users can override AI recommendations for training plans. **Phase 4 Personal Baseline Tuning:** Allows users with naturally low HRV or high heart rate to get accurate readiness scores by scoring relative to their personal baseline values instead of population averages. Features include auto-calculate from 30-day historical data, manual baseline entry, and baseline-relative scoring algorithm that measures % deviation from user's personal normal.
- **AI Insights Scheduling System:** Interactive recommendation scheduling with thumbs up/down feedback, integration with training plans, safety validation for core workouts, auto-hide logic, and AI learning from user feedback.
- **Supplement Tracking & Daily Reminders System:** AI-powered supplement recommendations based on biomarker data, structured saving via `SAVE_SUPPLEMENT` markers, dedicated management page for current stack, AI recommendations, and daily schedule. Includes a daily reminders card on the Training page with checkbox completion, streak tracking, and automatic reminder creation from accepted AI recommendations. The system supports multi-use reminders beyond supplements.
- **AI Exercise Recommendations with Smart Auto-Scheduling:** AI analyzes user health data and recommends supplementary exercises (mobility, stretching, core, cardio, recovery) with intelligent frequency-based scheduling. Features include auto-schedule at AI-recommended frequency (daily, 3x/week, 5x/week), manual day picker with calendar view, conflict detection showing existing workouts/supplements, visual busy indicators (light/moderate/busy), timezone-safe date scheduling, and status tracking (pending/scheduled/declined). Exercises are marked as supplementary to avoid overriding core workouts.
- **Fitness Profile Personalization System:** Comprehensive user fitness profiling enables AI to generate perfectly calibrated workouts. Features include database schema for fitness level, training experience, equipment access, facilities, goals, preferences, and injury limitations. AI auto-update capability via UPDATE_FITNESS_PROFILE markers allows profile population from natural conversation. Fitness profile loaded on every chat interaction and included in AI system prompts. AI uses profile for intensity calibration, equipment-based exercise selection, injury-aware programming, and goal alignment. Profile completion check displays guided setup banner on Training page for new users. Supports both manual profile entry via dedicated form and automatic updates through AI conversation. Production-ready with Zod validation, partial update merging, and security enforcement.
- **Capacitor iOS Native App:** Complete native iOS app implementation using Capacitor 7 framework. Wraps the existing React web app in a native shell while maintaining 100% code reuse. Includes direct HealthKit integration via capacitor-health plugin for native health data access. Features: platform detection to show iOS-specific HealthKit sync UI, web fallback with webhook instructions, HealthKit service bridge (`healthKitService`) for permissions and data queries, dedicated sync endpoint (`/api/apple-health/sync`), supports all biomarker types (steps, HRV, sleep, workouts, weight, body fat, lean mass), 30-day historical data sync, sync status UI with loading/success/error states. Configuration: Bundle ID `com.healthinsights.ai`, HealthKit permissions in Info.plist, TypeScript service with type-safe API, builds to App Store-ready binary. See `CAPACITOR_IOS_SETUP.md` for complete build and deployment instructions.

**Feature Specifications:**
- Health record upload and AI analysis with status tracking.
- Weekly Meal Planning System: AI-generated personalized meal plans with a 4-day rolling window, automatic date assignment, smart cleanup, weekly calendar view, and detailed recipe modal.
- AI Macro Recommendations: Intelligent nutrition target suggestions based on user goals, biomarkers, and training schedule. The AI analyzes active health goals, current weight, body fat percentage, training frequency, and dietary preferences to recommend optimal daily calorie and macronutrient targets (protein, carbs, fat) with detailed explanation. Users can apply recommendations directly or customize targets before saving.
- AI-powered alternative therapy recommendations.
- Admin control panel for user and subscription management.
- Auto-Save Training Plans from Chat based on user confirmation.
- **Contextual AI Onboarding:** Two-phase adaptive system via FloatingChat widget. Phase 1: Quick basic info collection (~1 min) via UPDATE_USER_PROFILE marker saves user age, height, weight, gender, and activity level. Phase 2: Page-specific setup prompts automatically trigger when users visit Training, Meals, Biomarkers, or Supplements sections for the first time. Granular completion tracking (basicInfoComplete, trainingSetupComplete, mealsSetupComplete, supplementsSetupComplete, biomarkersSetupComplete) ensures contextual AI guidance. UI auto-clears when contextual prompts trigger while preserving full conversation history in database for AI context. Includes browser timezone auto-detection on login.
- **Contextual Chat Opening Questions:** FloatingChat widget displays page-specific contextual questions when opening on different pages (Dashboard, Training, Meal Plans, Biomarkers, Supplement Stack, Sleep Dashboard, Health Goals). Each contextual question is tailored to the current page context, improving user engagement and making the AI assistant more relevant. Session-based UI reset system using sessionId state prevents flash of previous messages while preserving full conversation history in database for AI context continuity.
- **Clean Dashboard Defaults:** New users see a streamlined dashboard with only 7 core Health Overview widgets by default (Readiness Score, Health Score, Biological Age, Goals Summary, Data Insights, Blood Glucose Chart, Weight Chart). Additional biomarker widgets are hidden by default but can be easily re-enabled via "Manage Widgets" modal. Dashboard preferences use ALL_OPTIONAL_WIDGETS constant for validation ensuring proper show/hide functionality and widget re-enablement. localStorage and API sync both use consistent validation. Version "5" dashboard preferences force cache clear for existing users.
- Data & Insights Dashboard: Includes AI trend predictions, period comparison of health metrics, and a comprehensive goal setting & tracking system.
- Biological Age (Premium Feature): Science-based calculation using the PhenoAge algorithm, requiring 9 blood biomarkers.

## External Dependencies

- **Database:** PostgreSQL (via Drizzle ORM)
- **AI:** OpenAI GPT-4o (via Replit AI Integrations)
- **Authentication:** Replit Auth (OpenID Connect)
- **File Storage:** Local file upload with secure validation.
- **Health Data Integration:** Apple Health via Health Auto Export iOS app webhook (web) and native HealthKit integration via Capacitor (iOS app).
- **Mobile Platform:** Capacitor 7 for native iOS app with direct HealthKit access.